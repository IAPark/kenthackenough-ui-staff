var config={api:"http://api.khe.pdilyard.com"};angular.module("khe",["ngRoute","ngCookies","btford.socket-io"]),angular.module("khe").config(["$locationProvider",function(e){e.html5Mode(!0)}]),angular.module("khe").config(["$routeProvider",function(e){e.when("/attendees",{templateUrl:"/views/attendees.html",controller:"StaffAttendeesCtrl as att"})}]).controller("StaffAttendeesCtrl",["User","Application",function(e,t){function r(){a.application.list().success(function(e){o.all=e.users,i()}).error(function(e){o.errors=e.errors||["An internal error has occurred"]})}function n(){a.user.socket().on("create",function(e){o.all.push(e),i()}),a.user.socket().on("update",function(e){o.all=o.all.map(function(t){return t._id==e._id&&(t.email=e.email),t}),i()}),a.user.socket().on("delete",function(e){o.all=o.all.filter(function(t){return t._id!=e._id}),i()}),a.application.socket().on("create",function(e){o.all=o.all.map(function(t){return t._id==e._id&&(t=e),t}),i()}),a.application.socket().on("update",function(e){o.all=o.all.map(function(t){return t._id==e._id&&(t=e),t}),i()}),a.application.socket().on("delete",function(e){o.all=o.all.map(function(t){return t._id==e._id&&(t.application=null),t}),i()})}function i(){o.filter.init(),o.filter.apply(o.filter.current)}var o=this,a={user:new e,application:new t};o.me=a.user.getMe(),o.errors=[],o.users=[],o.all=[],o.applied=[],o.going=[],o.approved=[],o.waitlisted=[],o.pending=[],o.denied=[],o.travel=[],o.checked=[],o.filter={current:"all",init:function(){o.applied=o.all.filter(function(e){return e.application}),o.going=o.all.filter(function(e){return e.application&&e.application.going}),o.approved=o.all.filter(function(e){return e.application&&"approved"==e.application.status}),o.waitlisted=o.all.filter(function(e){return e.application&&"waitlisted"==e.application.status}),o.pending=o.all.filter(function(e){return e.application&&"pending"==e.application.status}),o.denied=o.all.filter(function(e){return e.application&&"denied"==e.application.status}),o.travel=o.all.filter(function(e){return e.application&&e.application.travel}),o.checked=o.all.filter(function(e){return e.application&&e.application.checked})},apply:function(e){switch(this.current=e,e){case"all":o.users=o.all;break;case"applied":o.users=o.applied;break;case"going":o.users=o.going;break;case"approved":o.users=o.approved;break;case"waitlisted":o.users=o.waitlisted;break;case"pending":o.users=o.pending;break;case"denied":o.users=o.denied;break;case"travel":o.users=o.travel;break;case"checked":o.users=o.checked}}},o.visibility={toggle:function(e){this.expandedId=this.expandedId==e._id?"":e._id},check:function(e){return this.expandedId==e._id}},o.status={edit:function(e){e.application.oldStatus=e.application.status,e.editingStatus=!0},save:function(e){a.application.updateById(e._id,{status:e.application.status}).success(function(){e.editingStatus=!1}).error(function(e){errors=e.errors||["An internal error occurred"]})},cancel:function(e){e.application.status=e.application.oldStatus,e.editingStatus=!1}},o.checkedIn={edit:function(e){e.application.oldChecked=e.application.checked,e.editingChecked=!0},save:function(e){a.application.updateById(e._id,{checked:e.application.checked}).success(function(){e.editingChecked=!1}).error(function(e){errors=e.errors||["An internal error occurred"]})},cancel:function(e){e.application.checked=e.application.oldChecked,e.editingChecked=!1}},o.role={edit:function(e){e.oldRole=e.role,e.editingRole=!0},save:function(e){a.user.updateById(e._id,{role:e.role}).success(function(){e.editingRole=!1}).error(function(e){errors=e.errors||["An internal error occurred"]})},cancel:function(e){e.role=e.oldRole,e.editingRole=!1}},r(),n()}]),angular.module("khe").config(["$routeProvider",function(e){e.when("/attendees/checkin",{templateUrl:"/views/checkin.html",controller:"StaffCheckInCtrl as checkin"})}]).controller("StaffCheckInCtrl",["User","Application","$scope",function(e,t){function r(){o.count=o.users.filter(function(e){return e.application&&e.application.checked}).length}function n(){a.application.list().success(function(e){o.users=e.users,r()}).error(function(e){o.errors=e.errors||["An internal error occurred"]})}function i(){a.application.socket().on("create",function(e){for(var t=o.users.length;t--;)if(o.users[t]._id==e._id){o.users[t]=e;break}r()}),a.application.socket().on("update",function(e){for(var t=o.users.length;t--;)if(o.users[t]._id==e._id){o.users[t]=e;break}r()}),a.application.socket().on("delete",function(e){for(var t=o.users.length;t--;)if(o.users[t]._id==e._id){o.users[t].application=null;break}r()}),a.user.socket().on("create",function(e){o.users.push(e),r()}),a.user.socket().on("update",function(e){for(var t=o.users.length;t--;)if(o.users[t]._id==e._id){o.users[t].email=e.email;break}r()}),a.user.socket().on("delete",function(e){for(var t=o.users.length;t--;)if(o.users[t]._id==e._id){o.users.splice(t,1);break}r()})}var o=this,a={user:new e,application:new t};o.me=a.user.getMe(),o.users=[],o.count=0,o.quick={application:{},register:function(){var e=this;e.application.phone=e.application.phone.replace(/\D/g,""),a.user.quick(e.application).success(function(){e.application={}}).error(function(e){o.errors=e.errors||["An internal error occurred"]})},edit:function(e){a.application.updateById(e._id,{name:e.app.name,phone:e.app.phone,submitted:!0,status:"approved",going:!0,checked:!0,time:Date.now(),demographic:!0,conduct:!0,travel:!1,waiver:!0,door:!0}).success(function(e){o.errors=null,console.log(e)}).error(function(e){console.log(e),o.errors=e.errors||["An internal error has occurred"]})}},o.toggleChecked=function(e){a.application.updateById(e._id,{checked:e.application.checked}).success(function(){}).error(function(e){o.errors=e.errors||["An internal error occurred"]})},o.visibility={toggle:function(e){this.expandedId=this.expandedId==e._id?"":e._id},check:function(e){return this.expandedId==e._id}},n(),i()}]),angular.module("khe").config(["$routeProvider",function(e){e.when("/emails",{templateUrl:"/views/emails.html",controller:"StaffEmailCtrl as ctrl"}).when("/emails/new",{templateUrl:"/views/emails-new.html",controller:"StaffEmailCtrl as ctrl"})}]).controller("StaffEmailCtrl",["User","Email","Application",function(e,t,r){function n(){a.email.list().success(function(e){o.emails=e.emails}).error(function(e){o.errors=e.errors||["An internal error occurred"]}),a.application.list().success(function(e){o.users=e.users}).error(function(e){o.errors=e.errors||["An internal error occurred"]})}function i(){a.email.socket().on("create",function(e){o.emails.push(e)}),a.email.socket().on("delete",function(e){o.emails=o.emails.filter(function(t){return t._id!=e._id})})}var o=this,a={user:new e,email:new t,application:new r};o.me=a.user.getMe();o.emails=[],o.compose={email:{},group:"all",send:function(){var e=this,t={subject:e.email.subject,body:e.email.body};if("custom"!=e.group)switch(e.group){case"all":angular.extend(t,{recipients:{nickname:"All",emails:o.users.map(function(e){return e.email})}});break;case"staff":angular.extend(t,{recipients:{nickname:"Staff",emails:o.users.filter(function(e){return"staff"==e.role||"admin"==e.role}).map(function(e){return e.email})}});break;case"applied":angular.extend(t,{recipients:{nickname:"Applied",emails:o.users.filter(function(e){return e.application}).map(function(e){return e.email})}});break;case"going":angular.extend(t,{recipients:{nickname:"Going",emails:o.users.filter(function(e){return e.application&&e.application.going}).map(function(e){return e.email})}});break;case"approved":angular.extend(t,{recipients:{nickname:"Approved",emails:o.users.filter(function(e){return e.application&&"approved"==e.application.status}).map(function(e){return e.email})}});break;case"waitlisted":angular.extend(t,{recipients:{nickname:"Waitlisted",emails:o.users.filter(function(e){return e.application&&"waitlisted"==e.application.status}).map(function(e){return e.email})}});break;case"pending":angular.extend(t,{recipients:{nickname:"Pending",emails:o.users.filter(function(e){return e.application&&"pending"==e.application.status}).map(function(e){return e.email})}});break;case"denied":angular.extend(t,{recipients:{nickname:"Denied",emails:o.users.filter(function(e){return e.application&&"denied"==e.application.status}).map(function(e){return e.email})}});break;case"travel":angular.extend(t,{recipients:{nickname:"Travel",emails:o.users.filter(function(e){return e.application&&e.application.travel}).map(function(e){return e.email})}});break;case"checked":angular.extend(t,{recipients:{nickname:"Checked In",emails:o.users.filter(function(e){return e.application&&e.application.checked}).map(function(e){return e.email})}})}else angular.extend(t,{recipients:{emails:e.email.emails.split(", ")}});a.email.send(t).success(function(){e.email={},e.group="all",o.successes=["Your message has been sent"]}).error(function(e){o.errors=e.errors||["An internal error has occurred"]})}},n(),i()}]),angular.module("khe").config(["$routeProvider",function(e){e.when("/",{templateUrl:"/views/home.html",controller:"StaffHomeCtrl"})}]).controller("StaffHomeCtrl",["User","$location",function(e,t){var r=this,n=new e;r.user=n.getMe(),r.user||t.path("/login"),r.logout=function(){n.removeMe(),t.path("/login")}}]),angular.module("khe").config(["$routeProvider",function(e){e.when("/live",{templateUrl:"/views/live.html",controller:"LiveCtrl as live"})}]).controller("LiveCtrl",["User","Message",function(e,t){function r(){o.message.list().success(function(e){i.messages=e.messages}).error(function(e){i.errors=e.errors||["An internal error has occurred"]})}function n(){o.message.socket().on("create",function(e){i.messages.push(e)}),o.message.socket().on("update",function(e){i.messages=i.messages.map(function(t){return t._id==e._id&&(t=e),t})}),o.message.socket().on("delete",function(e){i.messages=i.messages.filter(function(t){return t._id!=e._id})})}var i=this,o={user:new e,message:new t};i.me=o.user.getMe(),i.messages=[],i.message={"new":{},create:function(){var e=this;o.message.create(e["new"].text).success(function(){e["new"]={}}).error(function(e){i.errors=e.errors||["An internal error had occurred"]})},"delete":function(e){o.message["delete"](e._id).success(function(){}).error(function(e){i.errors=e.errors||["An internal error has occurred"]})}},r(),n()}]),angular.module("khe").config(["$routeProvider",function(e){e.when("/login",{templateUrl:"/views/login.html",controller:"StaffLoginCtrl"})}]).controller("StaffLoginCtrl",["User","$location",function(e,t){var r=this,n=new e;r.login=function(){n.login({email:r.user.email,password:r.user.password}).success(function(e){n.setMe(e),t.path("/")}).error(function(e){e&&(r.errors=e.errors||["An internal error has occurred"])})}}]),angular.module("khe").config(["$routeProvider",function(e){e.when("/tickets",{templateUrl:"/views/tickets.html",controller:"StaffTicketCtrl as ctrl"})}]).controller("StaffTicketCtrl",["User","Ticket",function(e,t){function r(){c.ticket.list().success(function(e){a.all=e.tickets,o()}).error(function(e){a.errors=e.errors||["An internal error occurred"]})}function n(){c.ticket.socket().on("create",function(e){a.tickets.push(e),o()}),c.ticket.socket().on("update",function(e){a.all=a.all.map(function(t){return t._id==e._id&&(t=e),t}),o()}),c.ticket.socket().on("delete",function(e){a.all=a.all.filter(function(t){return t._id!=e._id}),o()})}function i(e){for(var t=0;t<e.length;t++){var r=e[t];r.prettyStatus=r.open&&!r.inProgress?"Open":r.open&&r.inProgress?"In Progress":"Closed"}}function o(){i(a.all),a.filter.init(),a.filter.apply(a.filter.current)}var a=this,c={user:new e,ticket:new t};a.me=c.user.getMe(),a.all=[],a.open=[],a.progress=[],a.closed=[],a.tickets=[],a.filter={current:"all",init:function(){a.open=a.all.filter(function(e){return"Open"==e.prettyStatus}),a.progress=a.all.filter(function(e){return"In Progress"==e.prettyStatus}),a.closed=a.all.filter(function(e){return"Closed"==e.prettyStatus})},apply:function(e){switch(this.current=e,e){case"all":a.tickets=a.all;break;case"open":a.tickets=a.open;break;case"progress":a.tickets=a.progress;break;case"closed":a.tickets=a.closed}}},a.visibility={toggle:function(e){this.expandedId=this.expandedId==e._id?"":e._id},check:function(e){return this.expandedId==e._id}},a.status={edit:function(e){e.editingStatus=!0,e.oldOpen=e.open,e.oldInProgress=e.inProgress},cancel:function(e){e.editingStatus=!1,e.open=e.oldOpen,e.inProgress=e.oldInProgress,self.prettifyStatus([e])},save:function(e){var t,r;"Open"==e.prettyStatus?(t=!0,r=!1):"In Progress"==e.prettyStatus?(t=!0,r=!0):(t=!1,r=!1),c.ticket.update(e._id,{open:t,inProgress:r,worker:a.me.email}).success(function(){e.editingStatus=!1}).error(function(e){a.errors=e.errors||["An internal error occurred"]})}},r(),n()}]),angular.module("khe").config(["$routeProvider",function(e){e.when("/tools",{templateUrl:"/views/tools.html",controller:"StaffToolsCtrl as tools"})}]).controller("StaffToolsCtrl",["User","Url",function(e,t){function r(){o.url.list().success(function(e){i.urls=e.urls}).error(function(e){i.errors=e.errors||["An internal error has occurred"]})}function n(){o.url.socket().on("create",function(e){i.urls.push(e)}),o.url.socket().on("delete",function(e){i.urls=i.urls.filter(function(t){return t._id!=e._id})})}var i=this,o={user:new e,url:new t};i.me=o.user.getMe(),i.urls=[],i.url={"new":{},save:function(){var e=this;o.url.shorten(e["new"].full,e["new"]["short"]).success(function(){e["new"]={}}).error(function(e){i.errors=e.errors||["An internal error occurred"]})},remove:function(e){o.url.remove(e._id).success(function(){}).error(function(e){i.errors=e.errors||["An internal error occurred"]})}},r(),n()}]),angular.module("khe").directive("requireadmin",function(){return{restrict:"E",transclude:!0,templateUrl:"/views/directives/requireadmin.html",scope:{user:"=user",error:"=error"}}}),angular.module("khe").directive("requirelogin",function(){return{restrict:"E",transclude:!0,templateUrl:"/views/directives/requirelogin.html",scope:{user:"=user",error:"=error"}}}),angular.module("khe").directive("requirestaff",function(){return{restrict:"E",transclude:!0,templateUrl:"/views/directives/requirestaff.html",scope:{user:"=user",error:"=error"}}}),angular.module("khe").directive("staffheader",["$compile",function(e){return{restrict:"E",templateUrl:"/views/directives/staffheader.html",link:function(t,r){e(r.contents())(t),$(document).foundation()}}}]),angular.module("khe").directive("staffsidebar",function(){return{restrict:"E",transclude:!0,templateUrl:"/views/directives/staffsidebar.html"}}),angular.module("khe").filter("application",function(){var e=this;return e.shirt=function(e){switch(e){case"S":return"Small";case"M":return"Medium";case"L":return"Large";case"XL":return"X-Large"}},e.first=function(e){return e?"Yes":"No"},e.dietary=function(e){if(e.length){for(var t=e[0],r=1;r<e.length;r++)t=t+", "+e[r];return t}return"None"},e.travel=function(e){return e?"Yes":"No"},e.checked=function(e){return e?"Yes":"No"},e.going=function(e){return void 0===e?"None":e===!1?"Not Going":"Going"},e.gender=function(e){return e?e:"-"},function(t,r){return e[r](t)}}),angular.module("khe").filter("base64Encode",function(){return function(e){var t,r,n,i,o,a,c,s,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,f=0,d="",p=[];if(!e)return e;e=unescape(encodeURIComponent(e));do t=e.charCodeAt(l++),r=e.charCodeAt(l++),n=e.charCodeAt(l++),s=t<<16|r<<8|n,i=s>>18&63,o=s>>12&63,a=s>>6&63,c=63&s,p[f++]=u.charAt(i)+u.charAt(o)+u.charAt(a)+u.charAt(c);while(l<e.length);d=p.join("");var h=e.length%3;return(h?d.slice(0,h-3):d)+"===".slice(h||3)}}),angular.module("khe").filter("capitalizeFirstLetter",function(){return function(e){return e[0].toUpperCase()+e.slice(1)}}),angular.module("khe").filter("formatPhone",function(){return function(e){var t=(""+e).replace(/\D/g,""),r=t.match(/^(\d{3})(\d{3})(\d{4})$/);return r?"("+r[1]+") "+r[2]+"-"+r[3]:null}}),angular.module("khe").filter("markdown",function(){return function(e){return marked(e)}}),angular.module("khe").filter("relativeDate",function(){return function(e){return moment(e).fromNow()}}),angular.module("khe").filter("unsafe",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]),angular.module("khe").factory("Application",["$http","$filter","socketFactory","User",function(e,t,r,n){var i=function(){var i=new n;this.APPROVED="approved",this.DENIED="denied",this.WAITLISTED="waitlisted",this.PENDING="pending";var o;this.socket=function(){if(!o){var e=i.getMe(),n=t("base64Encode")(e.key+":"+e.token),a=io.connect(config.api+"/users/application",{query:"authorization="+n});o=r({ioSocket:a})}return o},this.submit=function(t){var r=i.authorize({method:"POST",url:config.api+"/users/application",data:t});return e(r)},this.get=function(){var t=i.authorize({method:"GET",url:config.api+"/users/me/application"});return e(t)},this.getById=function(t){var r=i.authorize({method:"GET",url:config.api+"/users/"+t+"/application"});return e(r)},this.list=function(){var t=i.authorize({method:"GET",url:config.api+"/users/application"});return e(t)},this.update=function(t){var r=i.authorize({method:"PATCH",url:config.api+"/users/me/application",data:t});return e(r)},this.updateById=function(t,r){var n=i.authorize({method:"PATCH",url:config.api+"/users/"+t+"/application",data:r});return e(n)},this["delete"]=function(){var t=i.authorize({method:"DELETE",url:config.api+"/users/me/application"});return e(t)},this.deleteById=function(t){var r=i.authorize({method:"DELETE",url:config.api+"/users/"+t+"/application"});return e(r)}};return i}]),angular.module("khe").factory("Email",["$http","$filter","User","socketFactory",function(e,t,r,n){var i=function(){var i,o=new r;this.socket=function(){if(!i){var e=o.getMe(),r=t("base64Encode")(e.key+":"+e.token),a=io.connect(config.api+"/emails",{query:"authorization="+r});i=n({ioSocket:a})}return i},this.send=function(t){var r=o.authorize({method:"POST",url:config.api+"/emails",data:t});return e(r)},this.list=function(){var t=o.authorize({method:"GET",url:config.api+"/emails"});return e(t)}};return i}]),angular.module("khe").factory("Message",["$http","socketFactory","User",function(e,t,r){var n=function(){var n,i=this,o=new r;this.socket=function(){if(!n){var e=io.connect(config.api+"/messages");n=t({ioSocket:e})}return n},i.list=function(){var t={method:"GET",url:config.api+"/messages"};return e(t)},i.get=function(t){var r={method:"GET",url:config.api+"/messages/"+t};return e(r)},i.create=function(t){var r=o.authorize({method:"POST",url:config.api+"/messages",data:{text:t}});return e(r)},i["delete"]=function(t){var r=o.authorize({method:"DELETE",url:config.api+"/messages/"+t});return e(r)}};return n}]),angular.module("khe").factory("Ticket",["$http","$filter","socketFactory","User",function(e,t,r,n){var i=function(){var i,o=this,a=new n;this.socket=function(){if(!i){var e=a.getMe(),n=t("base64Encode")(e.key+":"+e.token),o=io.connect(config.api+"/tickets",{query:"authorization="+n});i=r({ioSocket:o})}return i},o.list=function(){var t=a.authorize({method:"GET",url:config.api+"/tickets"});return e(t)},o.get=function(t){var r=a.authorize({method:"GET",url:config.api+"/tickets/"+t});return e(r)},o.create=function(t){var r={method:"POST",url:config.api+"/tickets",data:t};return e(r)},o.update=function(t,r){var n=a.authorize({method:"PATCH",url:config.api+"/tickets/"+t,data:r});return e(n)},o["delete"]=function(t){var r=a.authorize({method:"DELETE",url:config.api+"/tickets/"+t});return e(r)}};return i}]),angular.module("khe").factory("Url",["$http","$filter","socketFactory","User",function(e,t,r,n){var i=function(){var i,o=new n;this.socket=function(){if(!i){var e=o.getMe(),n=t("base64Encode")(e.key+":"+e.token),a=io.connect(config.api+"/urls",{query:"authorization="+n});i=r({ioSocket:a})}return i},this.shorten=function(t,r){var n=o.authorize({method:"POST",url:config.api+"/urls",data:{full:t,"short":r}});return e(n)},this.remove=function(t){var r=o.authorize({method:"DELETE",url:config.api+"/urls/"+t});return e(r)},this.list=function(){var t=o.authorize({method:"GET",url:config.api+"/urls"});return e(t)}};return i}]),angular.module("khe").factory("User",["$http","$cookieStore","$filter","socketFactory",function(e,t,r,n){var i=function(){var i;this.socket=function(){if(!i){var e=this.getMe(),t=r("base64Encode")(e.key+":"+e.token),o=io.connect(config.api+"/users",{query:"authorization="+t});i=n({ioSocket:o})}return i},this.setMe=function(e){Modernizr.localstorage?localStorage.setItem("me",angular.toJson(e)):t.put("me",e)},this.getMe=function(){return Modernizr.localstorage?angular.fromJson(localStorage.getItem("me")):t.get("me")},this.removeMe=function(){var r=this.authorize({method:"DELETE",url:config.api+"/users/token"});e(r),Modernizr.localstorage?localStorage.removeItem("me"):t.remove("me")},this.authorize=function(e){var t=this.getMe(),n=r("base64Encode")(t.key+":"+t.token),i={headers:{Authorization:"Basic "+n}};return angular.extend(e,i),e},this.register=function(t){var r={method:"POST",url:config.api+"/users",data:{email:t.email,password:t.password}};return e(r)},this.quick=function(t){var r=this.authorize({method:"POST",url:config.api+"/users/quick",data:{name:t.name,email:t.email,phone:t.phone}});return e(r)},this.login=function(t){var r={method:"POST",url:config.api+"/users/token",data:{email:t.email,password:t.password}};return e(r)},this.list=function(){var t=this.authorize({method:"GET",url:config.api+"/users"});return e(t)},this.get=function(t){var r=this.authorize({method:"GET",url:config.api+"/users/"+t});return e(r)},this.update=function(t){var r=this.authorize({method:"PATCH",url:config.api+"/users",data:t});return e(r)},this.updateById=function(t,r){var n=this.authorize({method:"PATCH",url:config.api+"/users/"+t,data:r});return e(n)},this["delete"]=function(t){var r=this.authorize({method:"DELETE",url:config.api+"/users/"+t});return e(r)}};return i}]);